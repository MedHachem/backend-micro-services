pipeline {
    agent any
    environment {
        NAMESPACE = 'nip-infra'
    }
    parameters {
            string(name: 'BRANCH_NAME', defaultValue: 'main', description: 'Branche à builder')
            choice(name: 'ACTION', choices: ['deploy'], description: 'Choisir  deploy')
            choice(name: 'SERVICE', choices: ['all','mysql','rabbitmq','usermanager'], description: 'Service à déployer')
        }
    stages {
     stage('Checkout') {
                steps {
                    echo "➡️ Checkout branche : ${params.BRANCH_NAME}"
                    git branch: "${params.BRANCH_NAME}",
                        url: "https://github.com/MedHachem/backend-micro-services.git"
                }
            }

        stage('Create Namespace') {
            steps {
                sh "kubectl create namespace ${NAMESPACE} || echo 'Namespace exists'"
            }
        }
         stage('Deploy Services') {
             steps {
                 script {
                     def services = [
                         mysql: [
                             resources: ['mysql-pvc.yaml','mysql-config.yaml','mysql-secret.yaml','mysql-deployment.yaml','mysql-service.yaml'],
                             selector: 'app=mysql'
                         ],
                         rabbitmq: [
                             resources: ['rabbitmq-pvc.yaml','rabbitmq-deployment.yaml','rabbitmq-service.yaml','rabbitmq-config.yaml','rabbitmq-secret.yaml'],
                             selector: 'app=rabbitmq'
                         ],
                     ]

                     def targets = params.SERVICE == 'all' ? services.keySet() : [params.SERVICE]

                     targets.each { name ->
                         echo "➡️ Déploiement ${name}"
                         services[name].resources.each { file ->
                             sh "kubectl apply -f k8s/${name}/${file} -n ${NAMESPACE} || true"
                         }
                         sh "kubectl rollout restart deployment ${name} -n ${NAMESPACE} || true"
                         sh "kubectl wait --for=condition=ready pod -l ${services[name].selector} -n ${NAMESPACE} --timeout=180s"
                     }
                 }
             }
         }

    }
}
