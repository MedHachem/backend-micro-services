services:

  # -----------------------------------------------------
  # üèõÔ∏è EUREKA SERVER
  # -----------------------------------------------------
  service-registery:
    build: ./service-registery
    container_name: service-registery
    ports:
      - "8761:8761"
    networks:
      - microservices-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://service-registery:8761"]
      interval: 10s
      timeout: 3s
      retries: 10

  # -----------------------------------------------------
  # ‚öôÔ∏è CONFIG SERVER
  # -----------------------------------------------------
  config-server:
    build: ./config-server
    container_name: config-server
    depends_on:
      service-registery:
        condition: service_healthy
    ports:
      - "8088:8088"
    networks:
      - microservices-net
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER_URL}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://config-server:8088/actuator/health"]
      interval: 10s
      timeout: 3s
      retries: 10

  # -----------------------------------------------------
  # üõ°Ô∏è API GATEWAY
  # -----------------------------------------------------
  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    depends_on:
      config-server:
        condition: service_healthy
    ports:
      - "8090:8090"
    networks:
      - microservices-net
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER_URL}
      SPRING_CONFIG_IMPORT: optional:configserver:http://${CONFIG_SERVER_HOST}:${CONFIG_SERVER_PORT}

  # -----------------------------------------------------
  # üóÉÔ∏è MYSQL DATABASE (for UserManager)
  # -----------------------------------------------------
  mysql:
    image: mysql:8
    container_name: mysql-db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: usermanagerdb
    ports:
      - "3306:3306"
    networks:
      - microservices-net
    volumes:
      - mysql-data:/var/lib/mysql
  # -----------------------------------------------------
  # üë§ AUTH MANAGER MS
  # -----------------------------------------------------
  auth-manager:
    build: ./auth-manager
    container_name: auth-manager
    depends_on:
      config-server:
        condition: service_healthy
      mysql:
        condition: service_started
    ports:
      - "8087:8087"
    networks:
      - microservices-net
    environment:
      SPRING_PROFILES_ACTIVE: docker
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER_URL}
      SPRING_CONFIG_IMPORT: optional:configserver:http://${CONFIG_SERVER_HOST}:${CONFIG_SERVER_PORT}
      SPRING_SECURITY_USER_NAME: ${SECURITY_USER_NAME}
      SPRING_SECURITY_USER_PASSWORD: ${SECURITY_USER_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      USERMANAGER_URL: http://${USER_MANAGER_HOST}:${USER_MANAGER_PORT}
  # -----------------------------------------------------
  # üë§ USER MANAGER MS
  # -----------------------------------------------------
  user-manager:
    build: ./user-manager
    container_name: user-manager
    depends_on:
      config-server:
        condition: service_healthy
      mysql:
        condition: service_started
    ports:
      - "8082:8082"
    networks:
      - microservices-net
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_CONFIG_IMPORT: optional:configserver:http://${CONFIG_SERVER_HOST}:${CONFIG_SERVER_PORT}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER_URL}
      SPRING_DATASOURCE_URL: jdbc:mysql://${DB_HOST}:${DB_PORT}/usermanagerdb?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true&createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: ${DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}

    # -----------------------------------------------------
    # üë§ RABBIT MQ
    # -----------------------------------------------------
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "${RABBITMQ_PORT}:5672"
      - "15672:15672" # UI management
    env_file:
      - .env
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USERNAME}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    networks:
      - microservices-net
    healthcheck:
      test: [ "CMD", "rabbitmqctl", "status" ]
      interval: 10s
      timeout: 5s
      retries: 5
    # -----------------------------------------------------
    # üë§ NOTIFICATION MANAGER MS
    # -----------------------------------------------------
  notification-manager:
      build: ./notification-manager
      container_name: notification-manager
      depends_on:
        config-server:
          condition: service_healthy
        mysql:
          condition: service_started
      env_file:
        - .env
      ports:
        - "8095:8095"
      networks:
        - microservices-net
      environment:
        SPRING_PROFILES_ACTIVE: prod
        SPRING_CONFIG_IMPORT: optional:configserver:http://${CONFIG_SERVER_HOST}:${CONFIG_SERVER_PORT}
        EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER_URL}
    # -----------------------------------------------------
    # üë§ OLLAMA
    # -----------------------------------------------------
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "${LLM_PORT}:11434" # port API
    networks:
      - microservices-net
    healthcheck:
      test: [ "CMD", "rabbitmqctl", "status" ]
      interval: 10s
      timeout: 5s
      retries: 5
  # -----------------------------------------------------
  # üë§ AI CONTENT GENERATOR MANAGER MS
  # -----------------------------------------------------
  ai-content-generator-manager:
    build: ./ai-content-generator-manager
    container_name: ai-content-generator-manager
    depends_on:
      config-server:
        condition: service_healthy
    ports:
      - "8097:8097"
    networks:
      - microservices-net
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_CONFIG_IMPORT: optional:configserver:http://${CONFIG_SERVER_HOST}:${CONFIG_SERVER_PORT}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_SERVER_URL}

# -----------------------------------------------------
# üîπ VOLUMES
# -----------------------------------------------------
volumes:
  mysql-data:

# -----------------------------------------------------
# üîπ NETWORKS
# -----------------------------------------------------
networks:
  microservices-net:
    driver: bridge
