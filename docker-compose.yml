services:

  # -----------------------------------------------------
  # üèõÔ∏è EUREKA SERVER
  # -----------------------------------------------------      
  service-registery:
   build: ./service-registery
   container_name: service-registery
   ports:
    - "8761:8761"
   networks:
    - microservices-net
   healthcheck:
     test: ["CMD", "curl", "-f", "http://service-registery:8761"]
     interval: 10s
     timeout: 3s
     retries: 10

  # -----------------------------------------------------
  # ‚öôÔ∏è CONFIG SERVER
  # -----------------------------------------------------
  config-server:
    build: ./config-server
    container_name: config-server
    depends_on:
      service-registery:
        condition: service_healthy
    ports:
      - "8088:8088"
    networks:
      - microservices-net
    environment:
      EUREKA_SERVER: http://service-registery:8761/eureka
    healthcheck:
      test: ["CMD", "curl", "-f", "http://config-server:8088/actuator/health"]
      interval: 10s
      timeout: 3s
      retries: 10

  # -----------------------------------------------------
  # üõ°Ô∏è API GATEWAY
  # -----------------------------------------------------
  gateway:
    build: ./api-gateway
    container_name: api-gateway
    depends_on:
      config-server:
        condition: service_healthy
    ports:
      - "8080:8080"
    networks:
      - microservices-net
    environment:
      CONFIG_SERVER_URL: http://config-server:8088
      EUREKA_SERVER: http://service-registery:8761/eureka

  # -----------------------------------------------------
  # üóÉÔ∏è MYSQL DATABASE (for UserManager)
  # -----------------------------------------------------
  mysql:
    image: mysql:8
    container_name: mysql-db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: usermanagerdb
    ports:
      - "3306:3306"
    networks:
      - microservices-net
    volumes:
      - mysql-data:/var/lib/mysql

  # -----------------------------------------------------
  # üë§ USER MANAGER MS
  # -----------------------------------------------------
  user-manager:
    build: ./user-manager
    container_name: user-manager
    depends_on:
      config-server:
        condition: service_healthy
      mysql:
        condition: service_started
    ports:
      - "8082:8082"
    networks:
      - microservices-net
    environment:
      SPRING_PROFILES_ACTIVE: docker
      CONFIG_SERVER_URL: http://config-server:8088
      EUREKA_SERVER: http://service-registery:8761/eureka
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/usermanagerdb
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: root

# -----------------------------------------------------
# üîπ VOLUMES
# -----------------------------------------------------
volumes:
  mysql-data:

# -----------------------------------------------------
# üîπ NETWORKS
# -----------------------------------------------------
networks:
  microservices-net:
    driver: bridge

